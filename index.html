<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Family Mapper AI</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --success-color: #22c55e;
            --warning-color: #f97316;
            --error-color: #ef4444;
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --text-dim: #6b7280;
            --border-color: #4b5563;
            --sidebar-width: 380px;
            --sidebar-collapsed: 56px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        
        #app {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        /* Header */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 1000;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 500;
        }
        
        .header-stats {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 12px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
        }
        
        .status-dot.warning {
            background: var(--warning-color);
        }
        
        .status-dot.pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            margin-top: 48px;
            position: relative;
        }
        
        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
            transition: margin-right 0.3s ease;
        }
        
        .map-container.sidebar-open {
            margin-right: var(--sidebar-width);
        }
        
        .map-container.sidebar-collapsed {
            margin-right: var(--sidebar-collapsed);
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 48px;
            right: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            transition: transform 0.3s ease, width 0.3s ease;
            z-index: 999;
            display: flex;
        }
        
        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }
        
        .sidebar-nav {
            width: var(--sidebar-collapsed);
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .nav-item {
            width: var(--sidebar-collapsed);
            height: var(--sidebar-collapsed);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            border: none;
            background: transparent;
            color: var(--text-secondary);
        }
        
        .nav-item:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: var(--primary-color);
            color: white;
        }
        
        .nav-item .icon {
            font-size: 20px;
        }
        
        .nav-item .badge {
            position: absolute;
            top: 8px;
            right: 8px;
            min-width: 18px;
            height: 18px;
            background: var(--error-color);
            color: white;
            border-radius: 9px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }
        
        .nav-item .tooltip {
            position: absolute;
            left: -120px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            border: 1px solid var(--border-color);
        }
        
        .sidebar.collapsed .nav-item:hover .tooltip {
            opacity: 1;
        }
        
        .sidebar-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar.collapsed .sidebar-content {
            display: none;
        }
        
        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .sidebar-title {
            font-size: 16px;
            font-weight: 500;
        }
        
        .sidebar-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .collapse-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .collapse-btn:hover {
            background: var(--bg-tertiary);
        }
        
        /* Sections */
        .section {
            margin-bottom: 16px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
        }
        
        .section-header:hover {
            background: var(--bg-primary);
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 500;
        }
        
        .section-arrow {
            transition: transform 0.2s;
        }
        
        .section.expanded .section-arrow {
            transform: rotate(180deg);
        }
        
        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .section.expanded .section-content {
            max-height: 2000px;
        }
        
        .section-body {
            padding: 12px 8px;
        }
        
        /* Cards */
        .card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .card:hover {
            border-color: var(--primary-color);
            transform: translateX(-2px);
        }
        
        .card.active {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .card-title {
            font-weight: 500;
            font-size: 14px;
        }
        
        .card-badge {
            padding: 2px 8px;
            background: var(--success-color);
            color: white;
            border-radius: 12px;
            font-size: 11px;
        }
        
        .card-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .card-detail {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* User Cards */
        .user-card {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .user-status {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .user-status.driving {
            color: var(--success-color);
        }
        
        /* Zone Cards */
        .zone-card {
            position: relative;
        }
        
        .zone-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .zone-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 4px;
        }
        
        .zone-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .zone-btn:hover {
            background: var(--primary-color);
            color: white;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 4px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-hover);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--bg-primary);
        }
        
        .btn-danger {
            background: var(--error-color);
            color: white;
        }
        
        .btn-block {
            width: 100%;
        }
        
        /* Zone Creator Overlay */
        .zone-creator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }
        
        .zone-creator.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .zone-creator-panel {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            min-width: 300px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .zone-creator-crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            pointer-events: none;
        }
        
        .zone-creator-crosshair::before,
        .zone-creator-crosshair::after {
            content: '';
            position: absolute;
            background: var(--primary-color);
        }
        
        .zone-creator-crosshair::before {
            width: 2px;
            height: 40px;
            left: 19px;
        }
        
        .zone-creator-crosshair::after {
            width: 40px;
            height: 2px;
            top: 19px;
        }
        
        .zone-creator-instructions {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1001;
        }
        
        /* Trip Details */
        .trip-details {
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 6px;
            margin-top: 8px;
        }
        
        .trip-stat {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
        }
        
        .trip-stat-label {
            color: var(--text-secondary);
        }
        
        .trip-stat-value {
            font-weight: 500;
        }
        
        .ai-summary {
            margin-top: 12px;
            padding: 12px;
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .ai-summary-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: #a855f7;
            font-weight: 500;
        }
        
        /* Date Range Picker */
        .date-picker {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .date-btn {
            flex: 1;
            padding: 6px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .date-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 32px 16px;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 48px;
            opacity: 0.3;
            margin-bottom: 12px;
        }
        
        .empty-title {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .empty-description {
            font-size: 12px;
        }
        
        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 32px;
        }
        
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .stat-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        /* Entity Selector */
        .entity-selector {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
            background: var(--bg-primary);
        }
        
        .entity-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px;
            font-size: 12px;
        }
        
        .entity-item input {
            cursor: pointer;
        }
        
        /* Visit History */
        .visit-item {
            padding: 8px;
            border-left: 3px solid var(--primary-color);
            background: var(--bg-primary);
            margin-bottom: 6px;
            border-radius: 0 4px 4px 0;
        }
        
        .visit-time {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .visit-duration {
            font-size: 12px;
            color: var(--text-primary);
            margin-top: 4px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
            }
            
            .sidebar.collapsed {
                width: var(--sidebar-collapsed);
            }
            
            .map-container.sidebar-open {
                display: none;
            }
            
            .header-stats {
                display: none;
            }
        }
        
        @keyframes slideRight {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(0); }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <span>üó∫Ô∏è</span>
                <span>Family Mapper AI</span>
            </div>
            <div class="header-stats">
                <div class="status-indicator">
                    <span class="status-dot" id="connectionDot"></span>
                    <span id="connectionStatus">Connecting...</span>
                </div>
                <div class="status-indicator" id="activeTripsStatus" style="display: none;">
                    <span class="status-dot pulse"></span>
                    <span id="activeTripsCount">0 driving</span>
                </div>
                <div class="status-indicator" id="aiStatus" style="display: none;">
                    <span>ü§ñ</span>
                    <span>AI Active</span>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Map -->
            <div class="map-container sidebar-open" id="mapContainer">
                <div id="map"></div>
                
                <!-- Zone Creator Overlay -->
                <div class="zone-creator" id="zoneCreator">
                    <div class="zone-creator-crosshair"></div>
                    <div class="zone-creator-instructions">
                        <div style="font-weight: 500; margin-bottom: 8px;">Place Your Zone</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            Click on the map to set zone center<br>
                            Use mouse wheel to zoom ‚Ä¢ Drag to pan
                        </div>
                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="placeZone()">Place Here</button>
                            <button class="btn btn-secondary" onclick="cancelZoneCreation()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <!-- Navigation -->
                <div class="sidebar-nav">
                    <button class="nav-item active" onclick="switchTab('users')" data-tab="users">
                        <span class="icon">üë•</span>
                        <span class="tooltip">Family Members</span>
                        <span class="badge" id="usersBadge" style="display: none;">0</span>
                    </button>
                    <button class="nav-item" onclick="switchTab('zones')" data-tab="zones">
                        <span class="icon">üìç</span>
                        <span class="tooltip">Zones</span>
                    </button>
                    <button class="nav-item" onclick="switchTab('driving')" data-tab="driving">
                        <span class="icon">üöó</span>
                        <span class="tooltip">Driving</span>
                        <span class="badge" id="drivingBadge" style="display: none;">0</span>
                    </button>
                    <button class="nav-item" onclick="switchTab('timeline')" data-tab="timeline">
                        <span class="icon">üìÖ</span>
                        <span class="tooltip">Timeline</span>
                    </button>
                    <button class="nav-item" onclick="switchTab('notifications')" data-tab="notifications">
                        <span class="icon">üîî</span>
                        <span class="tooltip">Notifications</span>
                    </button>
                    <button class="nav-item" onclick="switchTab('settings')" data-tab="settings">
                        <span class="icon">‚öôÔ∏è</span>
                        <span class="tooltip">Settings</span>
                    </button>
                    
                    <div style="flex: 1;"></div>
                    
                    <button class="nav-item" onclick="toggleSidebar()">
                        <span class="icon" id="toggleIcon">‚óÄ</span>
                        <span class="tooltip">Toggle Sidebar</span>
                    </button>
                </div>
                
                <!-- Content -->
                <div class="sidebar-content">
                    <!-- Users Tab -->
                    <div class="tab-content" id="tab-users">
                        <div class="sidebar-header">
                            <div class="sidebar-title">Family Members</div>
                        </div>
                        <div class="sidebar-body" id="usersContent">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Zones Tab -->
                    <div class="tab-content" id="tab-zones" style="display: none;">
                        <div class="sidebar-header">
                            <div class="sidebar-title">Zones</div>
                        </div>
                        <div class="sidebar-body">
                            <button class="btn btn-primary btn-block" onclick="startZoneCreation()">
                                ‚ûï Create New Zone
                            </button>
                            <div id="zonesContent" style="margin-top: 16px;">
                                <div class="empty-state">
                                    <div class="empty-icon">üìç</div>
                                    <div class="empty-title">No Zones</div>
                                    <div class="empty-description">Create zones to track locations</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Driving Tab -->
                    <div class="tab-content" id="tab-driving" style="display: none;">
                        <div class="sidebar-header">
                            <div class="sidebar-title">Driving Activity</div>
                        </div>
                        <div class="sidebar-body">
                            <div class="stats-grid" id="drivingStats">
                                <div class="stat-card">
                                    <div class="stat-value" id="todayTrips">0</div>
                                    <div class="stat-label">Today's Trips</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="todayMiles">0</div>
                                    <div class="stat-label">Miles Today</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="activeNow">0</div>
                                    <div class="stat-label">Active Now</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="avgSpeed">0</div>
                                    <div class="stat-label">Avg Speed</div>
                                </div>
                            </div>
                            <div id="tripsContent">
                                <div class="empty-state">
                                    <div class="empty-icon">üöó</div>
                                    <div class="empty-title">No Trips</div>
                                    <div class="empty-description">Trips appear when family members drive</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Timeline Tab -->
                    <div class="tab-content" id="tab-timeline" style="display: none;">
                        <div class="sidebar-header">
                            <div class="sidebar-title">Timeline</div>
                        </div>
                        <div class="sidebar-body">
                            <div class="date-picker">
                                <button class="date-btn active" onclick="setTimelineRange('today')">Today</button>
                                <button class="date-btn" onclick="setTimelineRange('week')">7 Days</button>
                                <button class="date-btn" onclick="setTimelineRange('month')">30 Days</button>
                                <button class="date-btn" onclick="showDatePicker()">Custom</button>
                            </div>
                            <div id="timelineContent">
                                <div class="empty-state">
                                    <div class="empty-icon">üìÖ</div>
                                    <div class="empty-title">No Events</div>
                                    <div class="empty-description">Activity will appear here</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notifications Tab -->
                    <div class="tab-content" id="tab-notifications" style="display: none;">
                        <div class="sidebar-header">
                            <div class="sidebar-title">Smart Automations</div>
                        </div>
                        <div class="sidebar-body">
                            <button class="btn btn-primary btn-block" onclick="addNotificationRule()">
                                <span id="notificationButtonText">‚ûï Add Notification Rule</span>
                            </button>
                            
                            <div id="notificationAIStatus" style="margin: 12px 0; padding: 8px; background: rgba(168, 85, 247, 0.1); 
                                        border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 6px; font-size: 11px; display: none;">
                                <div style="color: #a855f7; font-weight: 500; margin-bottom: 4px;">
                                    ü§ñ AI-Powered Automations
                                </div>
                                <div style="color: var(--text-secondary);">
                                    Describe what you want and AI will create the automation
                                </div>
                            </div>
                            
                            <div id="notificationRules" style="margin-top: 16px;">
                                <div class="empty-state">
                                    <div class="empty-icon">üîî</div>
                                    <div class="empty-title">No Automations</div>
                                    <div class="empty-description">Create smart notifications and automations</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Settings Tab -->
                    <div class="tab-content" id="tab-settings" style="display: none;">
                        <div class="sidebar-header">
                            <div class="sidebar-title">Settings</div>
                        </div>
                        <div class="sidebar-body">
                            <!-- Connection Section -->
                            <div class="section expanded">
                                <div class="section-header" onclick="toggleSection(this)">
                                    <div class="section-title">üîå Connection</div>
                                    <div class="section-arrow">‚ñº</div>
                                </div>
                                <div class="section-content">
                                    <div class="section-body">
                                        <div class="form-group">
                                            <label class="form-label">Home Assistant URL</label>
                                            <input type="text" class="form-input" id="haUrl" placeholder="http://192.168.1.3:8123" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Access Token</label>
                                            <input type="password" class="form-input" id="haToken" placeholder="Long-lived access token" />
                                        </div>
                                        <button class="btn btn-primary btn-block" onclick="saveConnection()">Save & Connect</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Entity Selection Section -->
                            <div class="section">
                                <div class="section-header" onclick="toggleSection(this)">
                                    <div class="section-title">üë§ Entity Selection</div>
                                    <div class="section-arrow">‚ñº</div>
                                </div>
                                <div class="section-content">
                                    <div class="section-body">
                                        <div class="form-label">Select entities to track:</div>
                                        <div class="entity-selector" id="entitySelector">
                                            <div class="empty-state">
                                                <div class="empty-description">Connect to Home Assistant first</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Features Section -->
                            <div class="section">
                                <div class="section-header" onclick="toggleSection(this)">
                                    <div class="section-title">‚ú® Features</div>
                                    <div class="section-arrow">‚ñº</div>
                                </div>
                                <div class="section-content">
                                    <div class="section-body">
                                        <div class="form-checkbox">
                                            <input type="checkbox" id="enableTrips" checked />
                                            <label for="enableTrips">Trip Detection</label>
                                        </div>
                                        <div class="form-checkbox">
                                            <input type="checkbox" id="enableNotifications" checked />
                                            <label for="enableNotifications">Notifications</label>
                                        </div>
                                        <div class="form-checkbox">
                                            <input type="checkbox" id="enableAI" onchange="toggleAISettings()" />
                                            <label for="enableAI">AI Summaries</label>
                                        </div>
                                        <div id="aiSettings" style="display: none; margin-top: 12px;">
                                            <div class="form-group">
                                                <label class="form-label">Gemini API Key</label>
                                                <input type="password" class="form-input" id="geminiKey" placeholder="Your Gemini API key" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Trip Settings Section -->
                            <div class="section">
                                <div class="section-header" onclick="toggleSection(this)">
                                    <div class="section-title">üöó Trip Detection</div>
                                    <div class="section-arrow">‚ñº</div>
                                </div>
                                <div class="section-content">
                                    <div class="section-body">
                                        <div class="form-group">
                                            <label class="form-label">Start Speed (mph)</label>
                                            <input type="number" class="form-input" id="tripSpeed" value="5" min="1" max="20" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Stop Duration (seconds)</label>
                                            <input type="number" class="form-input" id="tripStop" value="120" min="30" max="600" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- General Section -->
                            <div class="section">
                                <div class="section-header" onclick="toggleSection(this)">
                                    <div class="section-title">‚ö° General</div>
                                    <div class="section-arrow">‚ñº</div>
                                </div>
                                <div class="section-content">
                                    <div class="section-body">
                                        <div class="form-group">
                                            <label class="form-label">Refresh Interval (seconds)</label>
                                            <input type="number" class="form-input" id="refreshInterval" value="5" min="1" max="60" />
                                        </div>
                                        <button class="btn btn-secondary btn-block" onclick="saveAllSettings()">Save All Settings</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ==========================================
        // Family Mapper AI - Enhanced Version
        // ==========================================
        
        // Global State
        let map;
        let markers = {};
        let zoneCircles = {};
        let tripPaths = {};
        let currentTripPath = null;
        
        let users = [];
        let zones = [];
        let trips = [];
        let activeTrips = {};
        let zoneEvents = [];
        let notificationRules = [];
        
        let selectedUser = null;
        let selectedTrip = null;
        let selectedZone = null;
        let selectedEntities = [];
        
        let isConnected = false;
        let hassUrl = '';
        let hassToken = '';
        let allEntities = [];
        
        let config = {
            enableTrips: true,
            enableNotifications: true,
            enableAI: false,
            geminiKey: '',
            tripSpeedThreshold: 5,
            tripStopDuration: 120,
            refreshInterval: 5
        };
        
        let userHistory = {};
        let lastPositions = {};
        let processedZoneEvents = new Set();
        
        let zoneCreationMode = false;
        let pendingZone = null;
        let pendingZoneCircle = null;
        let zoneEditMode = null;
        
        let timelineRange = 'today';
        let refreshTimer = null;
        
        // ==========================================
        // Initialization
        // ==========================================
        
        async function init() {
            initMap();
            loadConfig();
            detectHomeAssistant();
            
            // Update notification UI based on config
            updateNotificationUI();
            
            // Try to auto-connect if we have credentials
            if (hassUrl && hassToken) {
                await testConnection();
            }
            
            // Only show mock data if not connected and no credentials
            if (!isConnected && (!hassUrl || !hassToken)) {
                loadMockData();
            }
            
            startRefreshTimer();
        }
        
        function updateNotificationUI() {
            const buttonText = document.getElementById('notificationButtonText');
            const aiStatus = document.getElementById('notificationAIStatus');
            
            if (buttonText) {
                buttonText.textContent = config.enableAI && config.geminiKey ? 
                    'ü§ñ Create Smart Automation' : 
                    '‚ûï Add Notification Rule';
            }
            
            if (aiStatus) {
                aiStatus.style.display = config.enableAI && config.geminiKey ? 'block' : 'none';
            }
        }
        
        function initMap() {
            map = L.map('map').setView([34.0522, -118.2437], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Add click handler for zone creation
            map.on('click', function(e) {
                if (zoneCreationMode && pendingZone) {
                    // Update pending zone position
                    pendingZone.lat = e.latlng.lat;
                    pendingZone.lng = e.latlng.lng;
                }
            });
        }
        
        function loadConfig() {
            const saved = localStorage.getItem('familyMapperConfig');
            if (saved) {
                const savedConfig = JSON.parse(saved);
                Object.assign(config, savedConfig);
                hassUrl = savedConfig.hassUrl || '';
                hassToken = savedConfig.hassToken || '';
                selectedEntities = savedConfig.selectedEntities || [];
                
                updateUIFromConfig();
            }
            
            // Load saved data
            const savedTrips = localStorage.getItem('familyMapperTrips');
            if (savedTrips) {
                trips = JSON.parse(savedTrips);
            }
            
            const savedEvents = localStorage.getItem('familyMapperEvents');
            if (savedEvents) {
                zoneEvents = JSON.parse(savedEvents);
            }
            
            const savedRules = localStorage.getItem('familyMapperNotifications');
            if (savedRules) {
                notificationRules = JSON.parse(savedRules);
            }
            
            const savedZones = localStorage.getItem('familyMapperZones');
            if (savedZones) {
                zones = JSON.parse(savedZones);
                updateZonesOnMap();
            }
        }
        
        function updateUIFromConfig() {
            document.getElementById('haUrl').value = hassUrl;
            document.getElementById('haToken').value = hassToken;
            document.getElementById('enableTrips').checked = config.enableTrips;
            document.getElementById('enableNotifications').checked = config.enableNotifications;
            document.getElementById('enableAI').checked = config.enableAI;
            document.getElementById('geminiKey').value = config.geminiKey || '';
            document.getElementById('tripSpeed').value = config.tripSpeedThreshold;
            document.getElementById('tripStop').value = config.tripStopDuration;
            document.getElementById('refreshInterval').value = config.refreshInterval;
            
            if (config.enableAI && config.geminiKey) {
                document.getElementById('aiStatus').style.display = 'block';
                document.getElementById('aiSettings').style.display = 'block';
            }
        }
        
        function detectHomeAssistant() {
            if (window.parent !== window) {
                try {
                    const parentUrl = window.parent.location.origin;
                    if (!hassUrl && parentUrl) {
                        hassUrl = parentUrl;
                        document.getElementById('haUrl').value = hassUrl;
                    }
                } catch (e) {
                    console.log('Cannot access parent window');
                }
            }
        }
        
        function startRefreshTimer() {
            if (refreshTimer) clearInterval(refreshTimer);
            
            refreshTimer = setInterval(() => {
                if (isConnected) {
                    loadHomeAssistantData();
                } else if (users.length > 0 && users[0].id.startsWith('person_john')) {
                    // Only update mock data if we're actually using mock data
                    updateMockData();
                }
            }, config.refreshInterval * 1000);
        }
        
        // ==========================================
        // Sidebar Management
        // ==========================================
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mapContainer = document.getElementById('mapContainer');
            const icon = document.getElementById('toggleIcon');
            
            if (sidebar.classList.contains('collapsed')) {
                sidebar.classList.remove('collapsed');
                mapContainer.classList.remove('sidebar-collapsed');
                mapContainer.classList.add('sidebar-open');
                icon.textContent = '‚óÄ';
            } else {
                sidebar.classList.add('collapsed');
                mapContainer.classList.remove('sidebar-open');
                mapContainer.classList.add('sidebar-collapsed');
                icon.textContent = '‚ñ∂';
            }
            
            setTimeout(() => map.invalidateSize(), 300);
        }
        
        function switchTab(tabName) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.dataset.tab === tabName) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            document.getElementById(`tab-${tabName}`).style.display = 'block';
            
            // Update content for the tab
            if (tabName === 'users') updateUsersPanel();
            if (tabName === 'zones') updateZonesPanel();
            if (tabName === 'driving') updateDrivingPanel();
            if (tabName === 'timeline') updateTimelinePanel();
            if (tabName === 'notifications') updateNotificationsPanel();
        }
        
        function toggleSection(header) {
            const section = header.parentElement;
            section.classList.toggle('expanded');
        }
        
        // ==========================================
        // Home Assistant Integration
        // ==========================================
        
        async function saveConnection() {
            hassUrl = document.getElementById('haUrl').value;
            hassToken = document.getElementById('haToken').value;
            
            if (!hassUrl || !hassToken) {
                alert('Please enter both URL and token');
                return;
            }
            
            // Test connection
            const connected = await testConnection();
            
            if (connected) {
                // Save config
                saveAllSettings();
                alert('Connected successfully!');
            } else {
                alert('Failed to connect. Check your URL and token.');
            }
        }
        
        async function testConnection() {
            if (!hassUrl || !hassToken) return false;
            
            try {
                const response = await fetch(`${hassUrl}/api/`, {
                    headers: {
                        'Authorization': `Bearer ${hassToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    isConnected = true;
                    updateConnectionStatus(true, 'Connected');
                    
                    // Load entities and data
                    await loadHomeAssistantData();
                    await loadAvailableEntities();
                    
                    return true;
                } else {
                    throw new Error('Connection failed');
                }
            } catch (error) {
                console.error('Connection error:', error);
                isConnected = false;
                updateConnectionStatus(false, 'Connection failed');
                return false;
            }
        }
        
        async function loadAvailableEntities() {
            if (!isConnected) return;
            
            try {
                const response = await fetch(`${hassUrl}/api/states`, {
                    headers: {
                        'Authorization': `Bearer ${hassToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const states = await response.json();
                    
                    // Filter for trackable entities
                    allEntities = states.filter(entity => 
                        (entity.entity_id.startsWith('person.') ||
                         entity.entity_id.startsWith('device_tracker.')) &&
                        entity.attributes.latitude !== undefined &&
                        entity.attributes.longitude !== undefined
                    );
                    
                    updateEntitySelector();
                }
            } catch (error) {
                console.error('Failed to load entities:', error);
            }
        }
        
        function updateEntitySelector() {
            const container = document.getElementById('entitySelector');
            
            if (allEntities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-description">No trackable entities found</div>
                    </div>
                `;
                return;
            }
            
            // Group entities by person
            const grouped = {};
            allEntities.forEach(entity => {
                const name = entity.attributes.friendly_name || entity.entity_id;
                const personName = name.split(' ')[0]; // Simple grouping by first word
                
                if (!grouped[personName]) {
                    grouped[personName] = [];
                }
                grouped[personName].push(entity);
            });
            
            let html = '';
            Object.keys(grouped).forEach(person => {
                if (grouped[person].length > 1) {
                    html += `<div style="margin-bottom: 12px;">`;
                    html += `<div style="font-weight: 500; margin-bottom: 4px;">${person}</div>`;
                    grouped[person].forEach(entity => {
                        const isChecked = selectedEntities.includes(entity.entity_id);
                        html += `
                            <div class="entity-item" style="margin-left: 16px;">
                                <input type="checkbox" 
                                       id="${entity.entity_id}" 
                                       value="${entity.entity_id}"
                                       ${isChecked ? 'checked' : ''}
                                       onchange="toggleEntity('${entity.entity_id}')">
                                <label for="${entity.entity_id}">
                                    ${entity.entity_id} 
                                    ${entity.state ? `(${entity.state})` : ''}
                                </label>
                            </div>
                        `;
                    });
                    html += `</div>`;
                } else {
                    const entity = grouped[person][0];
                    const isChecked = selectedEntities.includes(entity.entity_id);
                    html += `
                        <div class="entity-item">
                            <input type="checkbox" 
                                   id="${entity.entity_id}" 
                                   value="${entity.entity_id}"
                                   ${isChecked ? 'checked' : ''}
                                   onchange="toggleEntity('${entity.entity_id}')">
                            <label for="${entity.entity_id}">
                                ${entity.attributes.friendly_name || entity.entity_id}
                            </label>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }
        
        function toggleEntity(entityId) {
            const index = selectedEntities.indexOf(entityId);
            if (index > -1) {
                selectedEntities.splice(index, 1);
            } else {
                selectedEntities.push(entityId);
            }
            
            saveAllSettings();
            loadHomeAssistantData();
        }
        
        async function loadHomeAssistantData() {
            if (!isConnected) return;
            
            try {
                const response = await fetch(`${hassUrl}/api/states`, {
                    headers: {
                        'Authorization': `Bearer ${hassToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const states = await response.json();
                    processHomeAssistantData(states);
                }
            } catch (error) {
                console.error('Failed to load HA data:', error);
                updateConnectionStatus(false, 'Connection error');
            }
        }
        
        function processHomeAssistantData(states) {
            // First, get all device trackers and persons with GPS
            let trackers = states.filter(entity => 
                (selectedEntities.length === 0 || selectedEntities.includes(entity.entity_id)) &&
                (entity.entity_id.startsWith('person.') || entity.entity_id.startsWith('device_tracker.')) &&
                entity.attributes.latitude !== undefined &&
                entity.attributes.longitude !== undefined
            );
            
            // If no selected entities, use all person entities
            if (selectedEntities.length === 0) {
                trackers = states.filter(entity =>
                    entity.entity_id.startsWith('person.') &&
                    entity.attributes.latitude !== undefined &&
                    entity.attributes.longitude !== undefined
                );
            }
            
            // Build a map of all sensors by device name
            const sensorMap = {};
            states.forEach(entity => {
                if (entity.entity_id.startsWith('sensor.')) {
                    // Extract device name from sensor entity_id
                    // Examples: sensor.aaron_s_s24_battery_level -> aaron_s_s24
                    //          sensor.ava_s22_battery_state -> ava_s22
                    const match = entity.entity_id.match(/sensor\.(.+?)_(battery_level|battery_state|charger_type|battery_temperature|last_update)/);
                    if (match) {
                        const deviceName = match[1];
                        const sensorType = match[2];
                        
                        if (!sensorMap[deviceName]) {
                            sensorMap[deviceName] = {};
                        }
                        sensorMap[deviceName][sensorType] = entity.state;
                    }
                }
            });
            
            // Group by person/user
            const grouped = {};
            trackers.forEach(entity => {
                const name = entity.attributes.friendly_name || entity.entity_id.split('.')[1];
                const personKey = name.split(' ')[0].toLowerCase();
                
                // Try to match device tracker with sensors
                let deviceSensors = {};
                const entityName = entity.entity_id.split('.')[1];
                
                // Look for matching sensors
                Object.keys(sensorMap).forEach(deviceName => {
                    // Check if this sensor belongs to this tracker
                    if (entityName.includes(deviceName) || deviceName.includes(entityName)) {
                        deviceSensors = sensorMap[deviceName];
                    }
                });
                
                // For person entities, try to find their device_tracker
                if (entity.entity_id.startsWith('person.')) {
                    // Look for associated device tracker
                    const personName = entity.entity_id.split('.')[1];
                    const deviceTracker = states.find(e => 
                        e.entity_id.startsWith('device_tracker.') &&
                        e.entity_id.includes(personName)
                    );
                    
                    if (deviceTracker) {
                        const trackerName = deviceTracker.entity_id.split('.')[1];
                        Object.keys(sensorMap).forEach(deviceName => {
                            if (trackerName.includes(deviceName) || deviceName.includes(trackerName)) {
                                deviceSensors = sensorMap[deviceName];
                            }
                        });
                    }
                }
                
                if (!grouped[personKey]) {
                    grouped[personKey] = {
                        id: `person_${personKey}`,
                        name: name.split(' ')[0],
                        entities: []
                    };
                }
                
                // Get battery level from either attributes or sensors
                let batteryLevel = entity.attributes.battery_level || 
                                  deviceSensors.battery_level || 
                                  100;
                
                // Parse battery level if it's a string
                if (typeof batteryLevel === 'string') {
                    batteryLevel = parseInt(batteryLevel) || 100;
                }
                
                // Determine charging status
                let isCharging = false;
                if (deviceSensors.battery_state) {
                    isCharging = deviceSensors.battery_state.toLowerCase() === 'charging';
                } else if (deviceSensors.charger_type) {
                    isCharging = deviceSensors.charger_type.toLowerCase() !== 'none' && 
                                deviceSensors.charger_type.toLowerCase() !== 'unknown';
                }
                
                grouped[personKey].entities.push({
                    entity_id: entity.entity_id,
                    lat: entity.attributes.latitude,
                    lng: entity.attributes.longitude,
                    battery: batteryLevel,
                    charging: isCharging,
                    speed: entity.attributes.speed || 0,
                    state: entity.state,
                    picture: entity.attributes.entity_picture || entity.attributes.picture || null,
                    lastUpdated: new Date(entity.last_updated || Date.now()),
                    sensors: deviceSensors
                });
            });
            
            // Merge entities for each person
            const oldUsers = [...users];
            users = Object.values(grouped).map(person => {
                // Use most recent location from all entities
                const mostRecent = person.entities.reduce((latest, entity) => 
                    !latest || entity.lastUpdated > latest.lastUpdated ? entity : latest
                );
                
                // Find old user to preserve location tracking
                const oldUser = oldUsers.find(u => u.id === person.id);
                
                return {
                    id: person.id,
                    name: person.name,
                    lat: mostRecent.lat,
                    lng: mostRecent.lng,
                    battery: mostRecent.battery,
                    charging: mostRecent.charging,
                    speed: mostRecent.speed,
                    state: mostRecent.state,
                    picture: mostRecent.picture,  // Add profile picture
                    lastUpdated: mostRecent.lastUpdated,
                    entities: person.entities.map(e => e.entity_id),
                    sensors: mostRecent.sensors,
                    currentLocationSince: oldUser ? oldUser.currentLocationSince : new Date()
                };
            });
            
            // Process movements
            if (config.enableTrips) {
                processUserMovements(oldUsers);
            }
            
            // Check zone events
            checkZoneEvents();
            
            // Update UI
            updateMap();
            updatePanels();
            
            // Load HA zones
            const haZones = states.filter(entity => entity.entity_id.startsWith('zone.'))
                .map(entity => ({
                    id: entity.entity_id,
                    name: entity.attributes.friendly_name || entity.entity_id.split('.')[1],
                    lat: entity.attributes.latitude || 0,
                    lng: entity.attributes.longitude || 0,
                    radius: entity.attributes.radius || 100,
                    color: '#3b82f6',
                    isHAZone: true
                }));
            
            // Merge with custom zones
            const customZones = zones.filter(z => !z.isHAZone);
            zones = [...haZones, ...customZones];
            updateZonesOnMap();
        }
        
        function updateConnectionStatus(connected, text) {
            const dot = document.getElementById('connectionDot');
            const status = document.getElementById('connectionStatus');
            
            if (connected) {
                dot.classList.remove('warning');
                dot.classList.add('status-dot');
            } else {
                dot.classList.add('warning');
            }
            
            status.textContent = text;
        }
        
        // ==========================================
        // Map Management
        // ==========================================
        
        function updateMap() {
            // Clear existing markers
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            markers = {};
            
            // Add user markers
            users.forEach(user => {
                const isActive = activeTrips[user.id];
                const profilePic = user.picture ? `<img src="${hassUrl}${user.picture}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">` : 
                                                  `<div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${user.name.charAt(0).toUpperCase()}</div>`;
                
                const icon = L.divIcon({
                    html: `
                        <div style="position: relative; width: 40px; height: 40px;">
                            <div style="width: 36px; height: 36px; border-radius: 50%;
                                        background: ${user.id === selectedUser ? '#3b82f6' : (isActive ? '#22c55e' : '#1f2937')};
                                        border: 2px solid ${user.id === selectedUser ? '#60a5fa' : (isActive ? '#86efac' : '#4b5563')};
                                        display: flex; align-items: center; justify-content: center;
                                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                                ${profilePic}
                            </div>
                            ${user.battery < 20 ? '<div style="position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: #ef4444; border-radius: 50%;"></div>' : ''}
                            ${isActive ? '<div style="position: absolute; bottom: -2px; right: -2px; width: 10px; height: 10px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite;"></div>' : ''}
                        </div>
                    `,
                    className: 'custom-marker',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                
                const marker = L.marker([user.lat, user.lng], { icon }).addTo(map);
                
                marker.bindPopup(`
                    <div style="min-width: 200px;">
                        <strong>${user.name}</strong><br>
                        State: ${user.state}<br>
                        Battery: ${user.battery}%<br>
                        Speed: ${user.speed} mph<br>
                        ${isActive ? '<span style="color: #22c55e;">üöó Currently Driving</span>' : ''}
                    </div>
                `);
                
                marker.on('click', () => selectUser(user.id));
                markers[user.id] = marker;
            });
            
            // Track if users have moved significantly (more than 100 meters)
            let shouldRecenter = false;
            if (window.lastUserPositions) {
                users.forEach(user => {
                    const lastPos = window.lastUserPositions[user.id];
                    if (lastPos) {
                        const distance = calculateDistance(
                            {lat: lastPos.lat, lng: lastPos.lng},
                            {lat: user.lat, lng: user.lng}
                        );
                        // 100 meters is approximately 0.062 miles
                        if (distance > 0.062) {
                            shouldRecenter = true;
                        }
                    }
                });
            } else {
                // First load, should center
                shouldRecenter = true;
            }
            
            // Store current positions for next comparison
            window.lastUserPositions = {};
            users.forEach(user => {
                window.lastUserPositions[user.id] = {lat: user.lat, lng: user.lng};
            });
            
            // Only auto-center if:
            // 1. Users have moved significantly (>100m) OR it's the first load
            // 2. No user is selected
            // 3. No trip is selected
            // 4. Auto-zoom is not disabled (zones not being edited)
            if (users.length > 0 && !selectedUser && !selectedTrip && !window.autoZoomDisabled && shouldRecenter) {
                setTimeout(() => {
                    const bounds = L.latLngBounds(users.map(u => [u.lat, u.lng]));
                    map.fitBounds(bounds, { padding: [50, 50] });
                }, 100);
            }
            
            // Update user count badge
            const badge = document.getElementById('usersBadge');
            if (users.length > 0) {
                badge.textContent = users.length;
                badge.style.display = 'block';
            }
            
            // Update active trips indicator
            const activeCount = Object.keys(activeTrips).length;
            if (activeCount > 0) {
                document.getElementById('activeTripsStatus').style.display = 'block';
                document.getElementById('activeTripsCount').textContent = `${activeCount} driving`;
                document.getElementById('drivingBadge').textContent = activeCount;
                document.getElementById('drivingBadge').style.display = 'block';
            } else {
                document.getElementById('activeTripsStatus').style.display = 'none';
                document.getElementById('drivingBadge').style.display = 'none';
            }
        }
        
        function updateZonesOnMap() {
            // Clear existing zones
            Object.values(zoneCircles).forEach(circle => map.removeLayer(circle));
            zoneCircles = {};
            
            // Add zones
            zones.forEach(zone => {
                const circle = L.circle([zone.lat, zone.lng], {
                    color: zone.color || '#3b82f6',
                    fillColor: zone.color || '#3b82f6',
                    fillOpacity: 0.2,
                    radius: zone.radius
                }).addTo(map);
                
                circle.bindPopup(`
                    <strong>${zone.name}</strong><br>
                    Radius: ${zone.radius}m
                `);
                
                circle.on('click', () => selectZone(zone.id));
                zoneCircles[zone.id] = circle;
            });
        }
        
        function showTripRoute(trip) {
            // Clear existing trip paths
            Object.values(tripPaths).forEach(path => map.removeLayer(path));
            tripPaths = {};
            
            if (currentTripPath) {
                map.removeLayer(currentTripPath);
                currentTripPath = null;
            }
            
            // Hide all other elements
            Object.values(markers).forEach(marker => marker.setOpacity(0.3));
            Object.values(zoneCircles).forEach(circle => circle.setStyle({ opacity: 0.1 }));
            
            // Draw trip route
            if (trip.waypoints && trip.waypoints.length > 1) {
                const points = trip.waypoints.map(w => [w.lat, w.lng]);
                
                currentTripPath = L.polyline(points, {
                    color: '#3b82f6',
                    weight: 4,
                    opacity: 0.8
                }).addTo(map);
                
                // Add start marker
                L.marker(points[0], {
                    icon: L.divIcon({
                        html: '<div style="background: #22c55e; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">START</div>',
                        className: 'trip-marker',
                        iconSize: [50, 20]
                    })
                }).addTo(map);
                
                // Add end marker
                L.marker(points[points.length - 1], {
                    icon: L.divIcon({
                        html: '<div style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">END</div>',
                        className: 'trip-marker',
                        iconSize: [40, 20]
                    })
                }).addTo(map);
                
                // Fit map to trip
                map.fitBounds(currentTripPath.getBounds(), { padding: [50, 50] });
            }
        }
        
        function clearTripRoute() {
            if (currentTripPath) {
                map.removeLayer(currentTripPath);
                currentTripPath = null;
            }
            
            // Restore visibility
            Object.values(markers).forEach(marker => marker.setOpacity(1));
            Object.values(zoneCircles).forEach(circle => circle.setStyle({ opacity: 1 }));
            
            // Clear trip markers
            map.eachLayer(layer => {
                if (layer.options && layer.options.className === 'trip-marker') {
                    map.removeLayer(layer);
                }
            });
            
            selectedTrip = null;
        }
        
        // ==========================================
        // Zone Management
        // ==========================================
        
        function startZoneCreation() {
            const zoneName = prompt('Enter zone name:');
            if (!zoneName) return;
            
            // Store the pending zone data
            pendingZone = {
                name: zoneName,
                radius: 150,  // Default radius in meters
                color: '#3b82f6',
                placed: false
            };
            
            // Enter zone creation mode
            zoneCreationMode = true;
            
            // Disable auto-zoom
            window.autoZoomDisabled = true;
            
            // Create instruction overlay
            const instructions = document.createElement('div');
            instructions.id = 'zoneInstructions';
            instructions.style.cssText = `
                position: absolute;
                top: 70px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--bg-secondary);
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.4);
                z-index: 1002;
                border: 2px solid #fbbf24;
                max-width: 400px;
            `;
            instructions.innerHTML = `
                <div style="font-weight: 500; margin-bottom: 12px; color: #fbbf24;">
                    üìç Creating Zone: ${zoneName}
                </div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                    Click on the map to place the zone
                </div>
                
                <div id="zoneRadiusControl" style="display: none; margin-bottom: 16px;">
                    <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 8px;">
                        Zone Radius: <span id="radiusDisplay" style="color: #fbbf24; font-weight: 500;">${pendingZone.radius}m</span>
                    </label>
                    <input type="range" 
                           id="radiusSlider"
                           min="50" 
                           max="1000" 
                           value="${pendingZone.radius}"
                           style="width: 100%; cursor: pointer;"
                           oninput="updatePendingZoneRadius(this.value)">
                    <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-dim); margin-top: 4px;">
                        <span>50m</span>
                        <span>500m</span>
                        <span>1km</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px;">
                    <button id="saveZoneBtn" class="btn btn-primary" style="flex: 1; background: #fbbf24; border-color: #fbbf24; display: none;" 
                            onclick="confirmZoneCreation()">
                        ‚úÖ Save Zone
                    </button>
                    <button class="btn btn-secondary" style="flex: 1;" 
                            onclick="cancelZoneCreation()">
                        ‚ùå Cancel
                    </button>
                </div>
            `;
            document.getElementById('mapContainer').appendChild(instructions);
            
            // Change cursor to crosshair
            map.getContainer().style.cursor = 'crosshair';
            
            // Add click handler for zone placement
            map.on('click', placeZoneAtClick);
        }
        
        function placeZoneAtClick(e) {
            if (!zoneCreationMode || !pendingZone) return;
            
            // Remove existing zone circle if any
            if (pendingZoneCircle) {
                map.removeLayer(pendingZoneCircle);
            }
            
            // Create zone at clicked location
            pendingZone.lat = e.latlng.lat;
            pendingZone.lng = e.latlng.lng;
            pendingZone.placed = true;
            
            // Create the zone preview circle
            pendingZoneCircle = L.circle([pendingZone.lat, pendingZone.lng], {
                color: '#fbbf24',  // Yellow/amber for preview
                fillColor: '#fbbf24',
                fillOpacity: 0.3,
                weight: 3,
                dashArray: '10, 5',  // Dashed border
                radius: pendingZone.radius
            }).addTo(map);
            
            // Update instructions
            const instructions = document.getElementById('zoneInstructions');
            if (instructions) {
                instructions.querySelector('div:nth-child(2)').innerHTML = `
                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                        ‚úÖ Zone placed! Click elsewhere to move it or adjust size below
                    </div>
                `;
                
                // Show radius control and save button
                document.getElementById('zoneRadiusControl').style.display = 'block';
                document.getElementById('saveZoneBtn').style.display = 'block';
            }
        }
        
        function updatePendingZoneRadius(radius) {
            if (!pendingZoneCircle) return;
            
            pendingZone.radius = parseInt(radius);
            pendingZoneCircle.setRadius(radius);
            
            const display = document.getElementById('radiusDisplay');
            if (display) {
                display.textContent = radius + 'm';
            }
        }
        
        function confirmZoneCreation() {
            if (!pendingZone || !pendingZone.placed) {
                alert('Please click on the map to place the zone first');
                return;
            }
            
            // Create the permanent zone
            const zone = {
                id: `zone_custom_${Date.now()}`,
                name: pendingZone.name,
                lat: pendingZone.lat,
                lng: pendingZone.lng,
                radius: pendingZone.radius,
                color: '#3b82f6',  // Normal zone color
                isCustom: true
            };
            
            // Save zone
            zones.push(zone);
            localStorage.setItem('familyMapperZones', JSON.stringify(zones));
            
            // Remove preview circle and add permanent one
            if (pendingZoneCircle) {
                map.removeLayer(pendingZoneCircle);
            }
            
            // Create permanent zone circle
            const circle = L.circle([zone.lat, zone.lng], {
                color: zone.color,
                fillColor: zone.color,
                fillOpacity: 0.2,
                weight: 2,
                radius: zone.radius
            }).addTo(map);
            
            circle.on('click', () => selectZone(zone.id));
            zoneCircles[zone.id] = circle;
            
            // Clean up
            cancelZoneCreation();
            
            // Update UI
            updateZonesPanel();
            
            // Show success message
            showToast(`‚úÖ Zone "${zone.name}" created successfully!`, 'success');
        }
        
        function cancelZoneCreation() {
            // Exit zone creation mode
            zoneCreationMode = false;
            
            // Remove click handler
            map.off('click', placeZoneAtClick);
            
            // Remove preview circle
            if (pendingZoneCircle) {
                map.removeLayer(pendingZoneCircle);
                pendingZoneCircle = null;
            }
            
            // Clear pending zone
            pendingZone = null;
            
            // Remove instructions
            const instructions = document.getElementById('zoneInstructions');
            if (instructions) {
                instructions.remove();
            }
            
            // Reset cursor
            map.getContainer().style.cursor = '';
            
            // Re-enable auto-zoom
            window.autoZoomDisabled = false;
        }
        
        function selectZone(zoneId) {
            if (selectedZone === zoneId) {
                // Clicking again deselects and hides history
                selectedZone = null;
                const existingHistory = document.querySelector('.zone-history');
                if (existingHistory) {
                    existingHistory.remove();
                }
            } else {
                // Remove any existing history
                const existingHistory = document.querySelector('.zone-history');
                if (existingHistory) {
                    existingHistory.remove();
                }
                
                selectedZone = zoneId;
                const zone = zones.find(z => z.id === zoneId);
                
                if (zone) {
                    // Center map on zone
                    map.setView([zone.lat, zone.lng], 16);
                    
                    // Show zone visit history
                    showZoneHistory(zoneId);
                }
            }
            
            updateZonesPanel();
        }
        
        function editZone(zoneId) {
            event.stopPropagation();
            const zone = zones.find(z => z.id === zoneId);
            if (!zone || !zone.isCustom) return;
            
            const circle = zoneCircles[zoneId];
            if (!circle) return;
            
            // Enter edit mode
            zoneEditMode = zoneId;
            window.autoZoomDisabled = true;
            
            // Change zone appearance to show it's being edited
            circle.setStyle({ 
                color: '#fbbf24', 
                fillColor: '#fbbf24',
                weight: 3,
                dashArray: '10, 5'
            });
            
            // Center map on zone
            map.setView([zone.lat, zone.lng], 16);
            
            // Create edit panel
            const editPanel = document.createElement('div');
            editPanel.id = 'zoneEditPanel';
            editPanel.style.cssText = `
                position: absolute;
                top: 70px;
                right: 20px;
                background: var(--bg-secondary);
                padding: 16px;
                border-radius: 8px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.4);
                z-index: 1002;
                width: 300px;
                border: 2px solid #fbbf24;
            `;
            editPanel.innerHTML = `
                <div style="font-weight: 500; margin-bottom: 12px; color: #fbbf24;">
                    ‚úèÔ∏è Edit Zone: ${zone.name}
                </div>
                
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">
                        Zone Name
                    </label>
                    <input type="text" 
                           id="editZoneName" 
                           value="${zone.name}"
                           style="width: 100%; padding: 6px; background: var(--bg-primary); 
                                  border: 1px solid var(--border-color); border-radius: 4px; 
                                  color: var(--text-primary);">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 8px;">
                        Radius: <span id="editRadiusDisplay" style="color: #fbbf24; font-weight: 500;">${zone.radius}m</span>
                    </label>
                    <input type="range" 
                           id="editRadiusSlider"
                           min="50" 
                           max="1000" 
                           value="${zone.radius}"
                           style="width: 100%; cursor: pointer;">
                    <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-dim); margin-top: 4px;">
                        <span>50m</span>
                        <span>500m</span>
                        <span>1km</span>
                    </div>
                </div>
                
                <div style="font-size: 11px; color: var(--text-dim); margin-bottom: 12px; padding: 8px; background: var(--bg-primary); border-radius: 4px;">
                    üí° Click on the map to move the zone
                </div>
                
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" style="flex: 1; background: #fbbf24; border-color: #fbbf24;" 
                            onclick="saveZoneEdit('${zoneId}')">
                        ‚úÖ Save
                    </button>
                    <button class="btn btn-danger" style="flex: 1;" 
                            onclick="deleteZone('${zoneId}')">
                        üóëÔ∏è Delete
                    </button>
                    <button class="btn btn-secondary" style="flex: 1;" 
                            onclick="cancelZoneEdit()">
                        ‚ùå Cancel
                    </button>
                </div>
            `;
            document.getElementById('mapContainer').appendChild(editPanel);
            
            // Add radius change listener
            document.getElementById('editRadiusSlider').addEventListener('input', function(e) {
                const newRadius = parseInt(e.target.value);
                circle.setRadius(newRadius);
                document.getElementById('editRadiusDisplay').textContent = newRadius + 'm';
            });
            
            // Add click handler to move zone
            map.on('click', function moveZone(e) {
                if (zoneEditMode === zoneId) {
                    circle.setLatLng(e.latlng);
                    zone.tempLat = e.latlng.lat;
                    zone.tempLng = e.latlng.lng;
                }
            });
            
            // Store the handler for cleanup
            zone.editClickHandler = 'moveZone';
        }
        
        function saveZoneEdit(zoneId) {
            const zone = zones.find(z => z.id === zoneId);
            const circle = zoneCircles[zoneId];
            if (!zone || !circle) return;
            
            // Get updated values
            zone.name = document.getElementById('editZoneName').value;
            zone.radius = parseInt(document.getElementById('editRadiusSlider').value);
            
            // Update position if it was moved
            if (zone.tempLat && zone.tempLng) {
                zone.lat = zone.tempLat;
                zone.lng = zone.tempLng;
                delete zone.tempLat;
                delete zone.tempLng;
            }
            
            // Update circle
            circle.setRadius(zone.radius);
            circle.setStyle({ 
                color: zone.color, 
                fillColor: zone.color,
                weight: 2,
                dashArray: null
            });
            
            // Save to storage
            localStorage.setItem('familyMapperZones', JSON.stringify(zones));
            
            // Clean up
            cancelZoneEdit();
            updateZonesPanel();
            
            showToast(`‚úÖ Zone "${zone.name}" updated!`, 'success');
        }
        
        function cancelZoneEdit() {
            // Remove all click handlers
            map.off('click');
            
            // Reset zone appearance and positions
            zones.forEach(zone => {
                const circle = zoneCircles[zone.id];
                if (circle) {
                    // Reset position if it was being edited
                    if (zone.tempLat && zone.tempLng) {
                        circle.setLatLng([zone.lat, zone.lng]);
                        delete zone.tempLat;
                        delete zone.tempLng;
                    }
                    
                    // Reset style
                    circle.setStyle({ 
                        color: zone.color || '#3b82f6', 
                        fillColor: zone.color || '#3b82f6',
                        weight: 2,
                        dashArray: null
                    });
                }
            });
            
            // Remove edit panel
            const editPanel = document.getElementById('zoneEditPanel');
            if (editPanel) {
                editPanel.remove();
            }
            
            // Re-enable auto-zoom
            window.autoZoomDisabled = false;
            zoneEditMode = null;
        }
        
        function deleteZone(zoneId) {
            if (!confirm('Delete this zone?')) return;
            
            // Clean up any edit mode first
            if (zoneEditMode === zoneId) {
                cancelZoneEdit();
            }
            
            zones = zones.filter(z => z.id !== zoneId);
            
            if (zoneCircles[zoneId]) {
                map.removeLayer(zoneCircles[zoneId]);
                delete zoneCircles[zoneId];
            }
            
            localStorage.setItem('familyMapperZones', JSON.stringify(zones));
            updateZonesPanel();
        }
        
        function showZoneHistory(zoneId) {
            const zone = zones.find(z => z.id === zoneId);
            if (!zone) return;
            
            // Filter events for this zone
            const zoneHistory = zoneEvents.filter(e => e.zoneId === zoneId);
            
            // Group visits by user and date
            const visits = {};
            
            zoneHistory.forEach(event => {
                if (event.type === 'enter') {
                    const dateKey = new Date(event.timestamp).toDateString();
                    const userKey = event.userName;
                    
                    if (!visits[userKey]) visits[userKey] = {};
                    if (!visits[userKey][dateKey]) visits[userKey][dateKey] = [];
                    
                    // Find matching leave event
                    const leaveEvent = zoneHistory.find(e => 
                        e.type === 'leave' && 
                        e.userId === event.userId && 
                        new Date(e.timestamp) > new Date(event.timestamp) &&
                        new Date(e.timestamp).toDateString() === dateKey
                    );
                    
                    visits[userKey][dateKey].push({
                        enterTime: event.timestamp,
                        leaveTime: leaveEvent ? leaveEvent.timestamp : null,
                        duration: leaveEvent ? leaveEvent.duration : null
                    });
                }
            });
            
            // Create detailed HTML for zone history
            let html = `
                <div style="padding: 12px; background: var(--bg-primary); border-radius: 6px; margin-top: 8px;">
                    <div style="font-weight: 500; margin-bottom: 12px; color: var(--primary-color);">
                        üìä Visit History: ${zone.name}
                    </div>
            `;
            
            if (Object.keys(visits).length === 0) {
                html += `<div style="color: var(--text-secondary); font-size: 12px;">No visits recorded yet</div>`;
            } else {
                Object.keys(visits).forEach(userName => {
                    const userVisits = visits[userName];
                    const totalVisits = Object.values(userVisits).reduce((sum, dayVisits) => sum + dayVisits.length, 0);
                    
                    html += `
                        <div style="margin-bottom: 16px;">
                            <div style="font-weight: 500; margin-bottom: 8px; color: var(--text-primary);">
                                üë§ ${userName} (${totalVisits} visits)
                            </div>
                    `;
                    
                    // Show visits by date
                    Object.keys(userVisits).sort((a, b) => new Date(b) - new Date(a)).slice(0, 7).forEach(date => {
                        const dayVisits = userVisits[date];
                        const formattedDate = new Date(date).toLocaleDateString('en-US', { 
                            weekday: 'short', 
                            month: 'short', 
                            day: 'numeric' 
                        });
                        
                        html += `
                            <div style="margin-left: 16px; margin-bottom: 8px;">
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">
                                    üìÖ ${formattedDate}
                                </div>
                        `;
                        
                        dayVisits.forEach(visit => {
                            const enterTime = new Date(visit.enterTime).toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit' 
                            });
                            const leaveTime = visit.leaveTime ? new Date(visit.leaveTime).toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit' 
                            }) : 'Still there';
                            
                            let durationText = '';
                            if (visit.duration) {
                                const hours = Math.floor(visit.duration / 60);
                                const minutes = Math.round(visit.duration % 60);
                                if (hours > 0) {
                                    durationText = `${hours}h ${minutes}m`;
                                } else {
                                    durationText = `${minutes}m`;
                                }
                            } else if (!visit.leaveTime) {
                                // Currently in zone
                                const duration = (new Date() - new Date(visit.enterTime)) / 60000;
                                const hours = Math.floor(duration / 60);
                                const minutes = Math.round(duration % 60);
                                if (hours > 0) {
                                    durationText = `${hours}h ${minutes}m (ongoing)`;
                                } else {
                                    durationText = `${minutes}m (ongoing)`;
                                }
                            }
                            
                            html += `
                                <div style="margin-left: 16px; padding: 4px 8px; background: var(--bg-tertiary); 
                                            border-radius: 4px; margin-bottom: 4px; font-size: 11px;">
                                    üì• ${enterTime} ‚Üí ${visit.leaveTime ? 'üì§' : 'üìç'} ${leaveTime}
                                    ${durationText ? `<span style="color: var(--primary-color); margin-left: 8px;">‚è±Ô∏è ${durationText}</span>` : ''}
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    });
                    
                    html += `</div>`;
                });
            }
            
            html += `</div>`;
            
            // Insert the history into the zone card
            const zoneCard = document.querySelector(`[onclick="selectZone('${zoneId}')"]`);
            if (zoneCard) {
                // Remove existing history if present
                const existingHistory = zoneCard.querySelector('.zone-history');
                if (existingHistory) {
                    existingHistory.remove();
                }
                
                // Add new history
                const historyDiv = document.createElement('div');
                historyDiv.className = 'zone-history';
                historyDiv.innerHTML = html;
                zoneCard.appendChild(historyDiv);
            }
        }
        
        // ==========================================
        // Trip Detection
        // ==========================================
        
        function processUserMovements(oldUsers) {
            users.forEach(user => {
                const oldUser = oldUsers.find(u => u.id === user.id);
                if (!oldUser) {
                    // New user, set current location time
                    user.currentLocationSince = new Date();
                    return;
                }
                
                // Check if user moved significantly (more than 50 meters)
                const distance = calculateDistance(
                    {lat: oldUser.lat, lng: oldUser.lng},
                    {lat: user.lat, lng: user.lng}
                );
                
                if (distance > 0.031) { // ~50 meters in miles
                    // User moved to new location
                    user.currentLocationSince = new Date();
                } else {
                    // User still at same location, preserve the time
                    user.currentLocationSince = oldUser.currentLocationSince || new Date();
                }
                
                // Initialize history
                if (!userHistory[user.id]) {
                    userHistory[user.id] = [];
                }
                
                // Add to history
                userHistory[user.id].push({
                    lat: user.lat,
                    lng: user.lng,
                    speed: user.speed,
                    timestamp: new Date()
                });
                
                // Keep only last hour
                const oneHourAgo = new Date(Date.now() - 3600000);
                userHistory[user.id] = userHistory[user.id].filter(h => h.timestamp > oneHourAgo);
                
                // Check for trip start/update/end
                const activeTrip = activeTrips[user.id];
                
                if (user.speed >= config.tripSpeedThreshold) {
                    if (!activeTrip) {
                        // Start new trip
                        const trip = {
                            id: `trip_${user.id}_${Date.now()}`,
                            userId: user.id,
                            userName: user.name,
                            startTime: new Date(),
                            startLocation: [user.lat, user.lng],
                            currentLocation: [user.lat, user.lng],
                            distance: 0,
                            maxSpeed: user.speed,
                            waypoints: [{lat: user.lat, lng: user.lng, timestamp: new Date()}],
                            status: 'active'
                        };
                        
                        activeTrips[user.id] = trip;
                        
                        if (config.enableNotifications) {
                            sendNotification(`${user.name} Started Driving`, `Speed: ${user.speed} mph`);
                        }
                    } else {
                        // Update trip
                        const lastPoint = activeTrip.waypoints[activeTrip.waypoints.length - 1];
                        const distance = calculateDistance(lastPoint, {lat: user.lat, lng: user.lng});
                        
                        activeTrip.currentLocation = [user.lat, user.lng];
                        activeTrip.distance += distance;
                        activeTrip.waypoints.push({lat: user.lat, lng: user.lng, timestamp: new Date()});
                        
                        if (user.speed > activeTrip.maxSpeed) {
                            activeTrip.maxSpeed = user.speed;
                        }
                    }
                } else if (activeTrip) {
                    // Check if trip should end
                    const lastMovement = activeTrip.waypoints[activeTrip.waypoints.length - 1];
                    const timeStopped = (new Date() - lastMovement.timestamp) / 1000;
                    
                    if (timeStopped >= config.tripStopDuration) {
                        // End trip
                        activeTrip.endTime = new Date();
                        activeTrip.endLocation = [user.lat, user.lng];
                        activeTrip.duration = activeTrip.endTime - activeTrip.startTime;
                        activeTrip.status = 'completed';
                        activeTrip.averageSpeed = activeTrip.distance / (activeTrip.duration / 3600000);
                        
                        trips.push(activeTrip);
                        delete activeTrips[user.id];
                        
                        localStorage.setItem('familyMapperTrips', JSON.stringify(trips));
                        
                        // Generate AI summary if enabled
                        if (config.enableAI && config.geminiKey) {
                            generateAISummary(activeTrip);
                        }
                        
                        if (config.enableNotifications) {
                            const duration = Math.round(activeTrip.duration / 60000);
                            sendNotification(
                                `${user.name} Completed Trip`,
                                `Distance: ${activeTrip.distance.toFixed(1)} mi, Duration: ${duration} min`
                            );
                        }
                    }
                }
                
                lastPositions[user.id] = [user.lat, user.lng];
            });
        }
        
        function calculateDistance(point1, point2) {
            const R = 3959; // Earth's radius in miles
            const lat1 = point1.lat * Math.PI / 180;
            const lat2 = point2.lat * Math.PI / 180;
            const deltaLat = (point2.lat - point1.lat) * Math.PI / 180;
            const deltaLon = (point2.lng - point1.lng) * Math.PI / 180;
            
            const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
                      Math.cos(lat1) * Math.cos(lat2) *
                      Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            
            return R * c;
        }
        
        // ==========================================
        // Zone Events
        // ==========================================
        
        function checkZoneEvents() {
            zones.forEach(zone => {
                users.forEach(user => {
                    const distance = calculateDistance(
                        {lat: user.lat, lng: user.lng},
                        {lat: zone.lat, lng: zone.lng}
                    );
                    
                    const inZone = distance * 5280 <= zone.radius; // Convert miles to feet
                    const eventKey = `${user.id}-${zone.id}`;
                    
                    if (inZone && !processedZoneEvents.has(eventKey)) {
                        // User entered zone
                        const event = {
                            id: Date.now().toString(),
                            userId: user.id,
                            userName: user.name,
                            zoneId: zone.id,
                            zoneName: zone.name,
                            type: 'enter',
                            timestamp: new Date(),
                            enterTime: new Date() // Track when they entered
                        };
                        
                        zoneEvents.push(event);
                        processedZoneEvents.add(eventKey);
                        
                        // Store enter time for duration calculation
                        if (!window.zoneEnterTimes) window.zoneEnterTimes = {};
                        window.zoneEnterTimes[eventKey] = new Date();
                        
                        localStorage.setItem('familyMapperEvents', JSON.stringify(zoneEvents));
                        
                        checkNotificationRules(event);
                        
                    } else if (!inZone && processedZoneEvents.has(eventKey)) {
                        // User left zone - calculate duration
                        const enterTime = window.zoneEnterTimes && window.zoneEnterTimes[eventKey];
                        const duration = enterTime ? (new Date() - enterTime) / 60000 : 0; // Duration in minutes
                        
                        const event = {
                            id: Date.now().toString(),
                            userId: user.id,
                            userName: user.name,
                            zoneId: zone.id,
                            zoneName: zone.name,
                            type: 'leave',
                            timestamp: new Date(),
                            duration: duration,
                            enterTime: enterTime
                        };
                        
                        zoneEvents.push(event);
                        processedZoneEvents.delete(eventKey);
                        
                        // Clear enter time
                        if (window.zoneEnterTimes) delete window.zoneEnterTimes[eventKey];
                        
                        localStorage.setItem('familyMapperEvents', JSON.stringify(zoneEvents));
                        
                        checkNotificationRules(event);
                    }
                });
            });
        }
        
        function checkNotificationRules(event) {
            if (!config.enableNotifications) return;
            
            notificationRules.forEach(rule => {
                if (rule.enabled &&
                    (rule.userId === 'all' || rule.userId === event.userId) &&
                    (rule.zoneId === 'all' || rule.zoneId === event.zoneId) &&
                    (rule.eventType === 'both' || rule.eventType === event.type)) {
                    
                    const title = rule.customTitle || 
                        `${event.userName} ${event.type === 'enter' ? 'arrived at' : 'left'} ${event.zoneName}`;
                    const message = rule.customMessage || 
                        `At ${new Date().toLocaleTimeString()}`;
                    
                    sendNotification(title, message);
                }
            });
        }
        
        // ==========================================
        // AI Integration
        // ==========================================
        
        async function generateAISummary(trip) {
            if (!config.geminiKey) return;
            
            try {
                const prompt = `
                    Analyze this driving trip and provide a brief, natural summary:
                    - Driver: ${trip.userName}
                    - Distance: ${trip.distance.toFixed(1)} miles
                    - Duration: ${Math.round(trip.duration / 60000)} minutes
                    - Max Speed: ${trip.maxSpeed} mph
                    - Average Speed: ${trip.averageSpeed?.toFixed(0) || 0} mph
                    - Number of waypoints: ${trip.waypoints.length}
                    
                    Provide insights about:
                    1. Trip efficiency
                    2. Driving pattern (smooth, erratic, normal)
                    3. Any notable observations
                    
                    Keep response under 100 words and conversational.
                `;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${config.geminiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const summary = data.candidates[0]?.content?.parts[0]?.text || 'Unable to generate summary';
                    
                    // Update trip with summary
                    trip.aiSummary = summary;
                    
                    // Update in storage
                    const tripIndex = trips.findIndex(t => t.id === trip.id);
                    if (tripIndex > -1) {
                        trips[tripIndex].aiSummary = summary;
                        localStorage.setItem('familyMapperTrips', JSON.stringify(trips));
                    }
                    
                    // Update UI if this trip is selected
                    if (selectedTrip === trip.id) {
                        updateDrivingPanel();
                    }
                }
            } catch (error) {
                console.error('Failed to generate AI summary:', error);
            }
        }
        
        // ==========================================
        // Notifications
        // ==========================================
        
        async function sendNotification(title, message) {
            // Try Home Assistant notify service
            if (isConnected && hassToken) {
                try {
                    await fetch(`${hassUrl}/api/services/notify/notify`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${hassToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: title,
                            message: message,
                            data: {
                                tag: 'family-mapper',
                                color: '#3b82f6'
                            }
                        })
                    });
                } catch (error) {
                    console.error('Failed to send HA notification:', error);
                }
            }
            
            // Browser notification fallback
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body: message });
            }
        }
        
        function addNotificationRule() {
            // Create a modal for notification setup
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 24px; width: 500px; max-width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h2 style="margin-bottom: 20px; color: var(--primary-color);">
                        ü§ñ Create Smart Notification
                    </h2>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary);">
                            What would you like to be notified about?
                        </label>
                        <textarea id="notificationGoal" 
                                  placeholder="Examples:&#10;‚Ä¢ Alert me when kids arrive at school&#10;‚Ä¢ Turn on porch lights when anyone comes home after sunset&#10;‚Ä¢ Send a message when Jane leaves work&#10;‚Ä¢ Play announcement when someone speeds"
                                  style="width: 100%; height: 100px; padding: 12px; background: var(--bg-primary); 
                                         border: 1px solid var(--border-color); border-radius: 6px; 
                                         color: var(--text-primary); font-size: 14px; resize: vertical;"></textarea>
                    </div>
                    
                    ${config.enableAI && config.geminiKey ? `
                        <div style="margin-bottom: 20px; padding: 12px; background: rgba(168, 85, 247, 0.1); 
                                    border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span>ü§ñ</span>
                                <span style="color: #a855f7; font-weight: 500;">AI Assistant Ready</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                I'll help create the perfect automation based on your description
                            </div>
                        </div>
                    ` : `
                        <div style="margin-bottom: 20px; padding: 12px; background: var(--bg-tertiary); border-radius: 6px;">
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                üí° Tip: Add a Gemini API key in Settings for AI-powered automation suggestions
                            </div>
                        </div>
                    `}
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-primary" style="flex: 1;" onclick="processNotificationWithAI()">
                            ${config.enableAI && config.geminiKey ? 'ü§ñ Create with AI' : '‚ûï Create Basic Rule'}
                        </button>
                        <button class="btn btn-secondary" style="flex: 1;" onclick="this.closest('div').parentElement.remove()">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('notificationGoal').focus();
        }
        
        async function processNotificationWithAI() {
            const goal = document.getElementById('notificationGoal').value;
            if (!goal) {
                alert('Please describe what you want to be notified about');
                return;
            }
            
            // Close the modal
            document.querySelector('[style*="position: fixed"]').remove();
            
            // Show processing
            showToast('ü§ñ Creating automation...', 'info');
            
            if (config.enableAI && config.geminiKey) {
                // Use AI to understand intent and create automation
                try {
                    const automationConfig = await generateAutomationWithAI(goal);
                    createAutomationFromAI(automationConfig);
                } catch (error) {
                    console.error('AI automation generation failed:', error);
                    createBasicNotificationRule(goal);
                }
            } else {
                createBasicNotificationRule(goal);
            }
        }
        
        async function generateAutomationWithAI(goal) {
            const prompt = `
                Analyze this home automation request for a family tracking system and create a structured automation:
                
                User Request: "${goal}"
                
                Available triggers:
                - Person enters/leaves zone
                - Speed exceeds threshold
                - Battery below level
                - Time of day
                - Trip starts/ends
                
                Available actions:
                - Send notification to phone
                - Turn on/off lights
                - Play announcement on speakers
                - Set thermostat
                - Lock/unlock doors
                - Send message to family members
                
                Create a JSON response with:
                {
                    "name": "Short descriptive name",
                    "description": "What this automation does",
                    "trigger": {
                        "type": "zone|speed|battery|time|trip",
                        "userId": "specific name or 'all'",
                        "zoneId": "zone name or 'all'",
                        "condition": "enter|leave|above|below|start|end",
                        "value": threshold if applicable
                    },
                    "conditions": [
                        {
                            "type": "time|sun|state",
                            "after": "sunset|time",
                            "before": "sunrise|time"
                        }
                    ],
                    "actions": [
                        {
                            "type": "notify|light|announce|climate|lock",
                            "target": "entity or device",
                            "message": "notification text",
                            "data": {}
                        }
                    ],
                    "automation_yaml": "Complete Home Assistant automation YAML"
                }
                
                Be specific and practical. Include the actual Home Assistant automation YAML.
            `;
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${config.geminiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }]
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                const text = data.candidates[0]?.content?.parts[0]?.text || '{}';
                
                // Parse JSON from response
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
            }
            
            throw new Error('Failed to generate automation');
        }
        
        function createAutomationFromAI(config) {
            const automation = {
                id: `automation_${Date.now()}`,
                name: config.name,
                description: config.description,
                trigger: config.trigger,
                conditions: config.conditions || [],
                actions: config.actions || [],
                yaml: config.automation_yaml,
                enabled: true,
                created: new Date()
            };
            
            // Save automation
            notificationRules.push(automation);
            localStorage.setItem('familyMapperNotifications', JSON.stringify(notificationRules));
            
            // Create automation in Home Assistant if possible
            if (isConnected && hassToken && automation.yaml) {
                createHAAutomation(automation);
            }
            
            updateNotificationsPanel();
            showToast(`‚úÖ Automation "${automation.name}" created!`, 'success');
        }
        
        async function createHAAutomation(automation) {
            try {
                // Create automation via Home Assistant API
                const response = await fetch(`${hassUrl}/api/config/automation/config/${automation.id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${hassToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: automation.id,
                        alias: automation.name,
                        description: automation.description,
                        ...automation.yaml
                    })
                });
                
                if (response.ok) {
                    automation.haId = automation.id;
                    automation.haConfigured = true;
                    localStorage.setItem('familyMapperNotifications', JSON.stringify(notificationRules));
                }
            } catch (error) {
                console.error('Failed to create HA automation:', error);
            }
        }
        
        function createBasicNotificationRule(goal) {
            // Fallback to basic rule creation
            const rule = {
                id: Date.now().toString(),
                name: goal.substring(0, 50),
                description: goal,
                enabled: true,
                trigger: {
                    type: 'zone',
                    userId: 'all',
                    zoneId: 'all',
                    condition: 'enter'
                },
                actions: [{
                    type: 'notify',
                    message: goal
                }],
                created: new Date()
            };
            
            notificationRules.push(rule);
            localStorage.setItem('familyMapperNotifications', JSON.stringify(notificationRules));
            updateNotificationsPanel();
            showToast('‚úÖ Notification rule created', 'success');
        }
        
        function updateNotificationsPanel() {
            const container = document.getElementById('notificationRules');
            
            if (notificationRules.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîî</div>
                        <div class="empty-title">No Automations</div>
                        <div class="empty-description">Create smart notifications and automations</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            notificationRules.forEach(rule => {
                const triggerText = rule.trigger ? 
                    `When ${rule.trigger.userId === 'all' ? 'anyone' : rule.trigger.userId} 
                     ${rule.trigger.condition}s ${rule.trigger.zoneId === 'all' ? 'any zone' : rule.trigger.zoneId}` :
                    'Manual trigger';
                
                const actionIcons = {
                    notify: 'üì±',
                    light: 'üí°',
                    announce: 'üîä',
                    climate: 'üå°Ô∏è',
                    lock: 'üîí'
                };
                
                html += `
                    <div class="card" style="margin-bottom: 12px;">
                        <div class="card-header">
                            <div style="flex: 1;">
                                <div class="card-title" style="display: flex; align-items: center; gap: 8px;">
                                    ${rule.haConfigured ? '‚úÖ' : '‚ö†Ô∏è'}
                                    ${rule.name}
                                </div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                                    ${rule.description || triggerText}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label class="switch" style="transform: scale(0.8);">
                                    <input type="checkbox" ${rule.enabled ? 'checked' : ''} 
                                           onchange="toggleRule('${rule.id}')">
                                    <span class="slider"></span>
                                </label>
                                <button class="zone-btn" onclick="deleteRule('${rule.id}')" title="Delete">üóëÔ∏è</button>
                            </div>
                        </div>
                        
                        ${rule.actions && rule.actions.length > 0 ? `
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color);">
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Actions:</div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    ${rule.actions.map(action => `
                                        <div style="display: inline-flex; align-items: center; gap: 4px; 
                                                    padding: 2px 8px; background: var(--bg-primary); 
                                                    border-radius: 12px; font-size: 11px;">
                                            ${actionIcons[action.type] || '‚ö°'}
                                            ${action.type}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${rule.haId ? `
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color);">
                                <a href="${hassUrl}/config/automation/edit/${rule.haId}" 
                                   target="_blank"
                                   style="display: inline-flex; align-items: center; gap: 4px; 
                                          font-size: 11px; color: var(--primary-color); text-decoration: none;">
                                    ‚öôÔ∏è Edit in Home Assistant
                                </a>
                            </div>
                        ` : (rule.yaml ? `
                            <div style="margin-top: 8px;">
                                <button class="btn btn-secondary btn-block" style="font-size: 12px;" 
                                        onclick="showAutomationYAML('${rule.id}')">
                                    üìã View YAML Code
                                </button>
                            </div>
                        ` : '')}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function showAutomationYAML(ruleId) {
            const rule = notificationRules.find(r => r.id === ruleId);
            if (!rule || !rule.yaml) return;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 24px; 
                            width: 600px; max-width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 16px;">Automation YAML</h3>
                    <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-primary); 
                                border-radius: 6px; font-size: 12px; color: var(--text-secondary);">
                        Copy this YAML and add it to your automations.yaml file or create a new automation in the UI
                    </div>
                    <pre style="background: var(--bg-primary); padding: 16px; border-radius: 6px; 
                                overflow-x: auto; font-size: 12px; color: var(--text-primary);">${rule.yaml}</pre>
                    <div style="margin-top: 16px; display: flex; gap: 12px;">
                        <button class="btn btn-primary" style="flex: 1;" 
                                onclick="copyToClipboard(\`${rule.yaml.replace(/`/g, '\\`')}\`)">
                            üìã Copy YAML
                        </button>
                        <button class="btn btn-secondary" style="flex: 1;" 
                                onclick="this.closest('div').parentElement.remove()">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('‚úÖ Copied to clipboard!', 'success');
            });
        }
        
        function showToast(message, type = 'info') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                padding: 12px 24px;
                background: ${type === 'success' ? 'var(--success-color)' : 
                             type === 'error' ? 'var(--error-color)' : 
                             'var(--primary-color)'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 9999;
                animation: slideUp 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideDown 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Add switch styles
        if (!document.querySelector('#switchStyles')) {
            const style = document.createElement('style');
            style.id = 'switchStyles';
            style.textContent = `
                .switch {
                    position: relative;
                    display: inline-block;
                    width: 40px;
                    height: 20px;
                }
                
                .switch input {
                    opacity: 0;
                    width: 0;
                    height: 0;
                }
                
                .slider {
                    position: absolute;
                    cursor: pointer;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-color: var(--bg-tertiary);
                    transition: .4s;
                    border-radius: 20px;
                }
                
                .slider:before {
                    position: absolute;
                    content: "";
                    height: 14px;
                    width: 14px;
                    left: 3px;
                    bottom: 3px;
                    background-color: white;
                    transition: .4s;
                    border-radius: 50%;
                }
                
                input:checked + .slider {
                    background-color: var(--success-color);
                }
                
                input:checked + .slider:before {
                    transform: translateX(20px);
                }
                
                .toast {
                    animation: slideUp 0.3s ease;
                }
                
                @keyframes slideUp {
                    from { transform: translate(-50%, 100px); opacity: 0; }
                    to { transform: translate(-50%, 0); opacity: 1; }
                }
                
                @keyframes slideDown {
                    from { transform: translate(-50%, 0); opacity: 1; }
                    to { transform: translate(-50%, 100px); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // ==========================================
        // Panel Updates
        // ==========================================
        
        function updatePanels() {
            const activeTab = document.querySelector('.nav-item.active').dataset.tab;
            
            if (activeTab === 'users') updateUsersPanel();
            if (activeTab === 'zones') updateZonesPanel();
            if (activeTab === 'driving') updateDrivingPanel();
            if (activeTab === 'timeline') updateTimelinePanel();
        }
        
        function updateUsersPanel() {
            const container = document.getElementById('usersContent');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë•</div>
                        <div class="empty-title">No Family Members</div>
                        <div class="empty-description">Connect to Home Assistant to see family members</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            users.forEach(user => {
                const isActive = activeTrips[user.id];
                
                // Calculate duration at current location
                let locationDuration = '';
                if (user.currentLocationSince) {
                    const duration = Date.now() - new Date(user.currentLocationSince).getTime();
                    const minutes = Math.floor(duration / 60000);
                    const hours = Math.floor(minutes / 60);
                    
                    if (hours > 0) {
                        locationDuration = `${hours}h ${minutes % 60}m`;
                    } else {
                        locationDuration = `${minutes}m`;
                    }
                }
                
                // Check which zone user is in
                let currentZone = null;
                zones.forEach(zone => {
                    const distance = calculateDistance(
                        {lat: user.lat, lng: user.lng},
                        {lat: zone.lat, lng: zone.lng}
                    );
                    if (distance * 5280 <= zone.radius) {
                        currentZone = zone.name;
                    }
                });
                
                html += `
                    <div class="card ${user.id === selectedUser ? 'active' : ''} ${isActive ? 'driving' : ''}" 
                         onclick="selectUser('${user.id}')">
                        <div class="user-card">
                            <div class="user-avatar" ${user.picture ? `style="background-image: url('${hassUrl}${user.picture}'); background-size: cover; background-position: center;"` : ''}>
                                ${!user.picture ? user.name.charAt(0).toUpperCase() : ''}
                            </div>
                            <div class="user-info">
                                <div class="user-name">${user.name}</div>
                                <div class="user-status ${isActive ? 'driving' : ''}">
                                    ${isActive ? 'üöó Driving' : (currentZone || user.state)}
                                </div>
                                ${locationDuration && !isActive ? `<div style="font-size: 11px; color: var(--text-secondary);">üìç ${locationDuration} here</div>` : ''}
                            </div>
                        </div>
                        <div class="card-details" style="margin-top: 8px;">
                            <div class="card-detail">
                                ${user.charging ? 'üîå' : 'üîã'} ${user.battery}%${user.charging ? ' ‚ö°' : ''}
                            </div>
                            <div class="card-detail">‚ö° ${user.speed} mph</div>
                            <div class="card-detail">üìç ${user.entities ? user.entities.length : 1} device${user.entities?.length > 1 ? 's' : ''}</div>
                            <div class="card-detail">üïê ${formatTime(user.lastUpdated)}</div>
                        </div>
                        ${isActive ? `
                            <div style="margin-top: 8px; padding: 8px; background: rgba(34, 197, 94, 0.1); border-radius: 4px;">
                                <div style="font-size: 12px; color: var(--success-color);">
                                    Active Trip: ${activeTrips[user.id].distance.toFixed(1)} mi
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function updateZonesPanel() {
            const container = document.getElementById('zonesContent');
            
            if (zones.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìç</div>
                        <div class="empty-title">No Zones</div>
                        <div class="empty-description">Create zones to track locations</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            zones.forEach(zone => {
                const usersInZone = users.filter(u => {
                    const distance = calculateDistance(
                        {lat: u.lat, lng: u.lng},
                        {lat: zone.lat, lng: zone.lng}
                    );
                    return distance * 5280 <= zone.radius;
                });
                
                html += `
                    <div class="card zone-card ${zone.id === selectedZone ? 'active' : ''}" 
                         onclick="selectZone('${zone.id}')">
                        <div class="zone-actions">
                            ${!zone.isHAZone ? `
                                <button class="zone-btn" onclick="event.stopPropagation(); editZone('${zone.id}')" title="Edit">‚úèÔ∏è</button>
                                <button class="zone-btn" onclick="event.stopPropagation(); deleteZone('${zone.id}')" title="Delete">üóëÔ∏è</button>
                            ` : ''}
                        </div>
                        <div class="card-header">
                            <div class="card-title">
                                <span class="zone-color" style="background: ${zone.color || '#3b82f6'}"></span>
                                ${zone.name}
                            </div>
                        </div>
                        <div class="card-details">
                            <div class="card-detail">üìè ${zone.radius}m</div>
                            <div class="card-detail">üë• ${usersInZone.length} here</div>
                        </div>
                        ${usersInZone.length > 0 ? `
                            <div style="margin-top: 8px; font-size: 11px; color: var(--text-secondary);">
                                ${usersInZone.map(u => u.name).join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function updateDrivingPanel() {
            // Get active trips
            const activeTripsArray = Object.values(activeTrips);
            
            // Calculate today's stats
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todaysTrips = trips.filter(t => new Date(t.startTime) >= today);
            const todayDistance = todaysTrips.reduce((sum, t) => sum + (t.distance || 0), 0) + 
                                 activeTripsArray.reduce((sum, t) => sum + (t.distance || 0), 0);
            const todayDuration = todaysTrips.reduce((sum, t) => sum + (t.duration || 0), 0) + 
                                 activeTripsArray.reduce((sum, t) => sum + ((new Date() - t.startTime) || 0), 0);
            
            // Update stats cards
            document.getElementById('todayTrips').textContent = todaysTrips.length + activeTripsArray.length;
            document.getElementById('todayMiles').textContent = todayDistance.toFixed(1);
            document.getElementById('activeNow').textContent = activeTripsArray.length;
            
            const avgSpeed = [...todaysTrips, ...activeTripsArray].length > 0
                ? [...todaysTrips, ...activeTripsArray].reduce((sum, t) => sum + (t.averageSpeed || t.maxSpeed || 0), 0) / 
                  [...todaysTrips, ...activeTripsArray].length
                : 0;
            document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(0);
            
            // Build the trips content
            const container = document.getElementById('tripsContent');
            let html = '';
            
            // Show active trips first with detailed info
            if (activeTripsArray.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <div style="width: 8px; height: 8px; background: var(--success-color); border-radius: 50%; animation: pulse 2s infinite;"></div>
                            <div style="font-weight: 500; color: var(--success-color);">Currently Driving</div>
                        </div>
                `;
                
                activeTripsArray.forEach(trip => {
                    const duration = Math.floor((new Date() - trip.startTime) / 60000);
                    const hours = Math.floor(duration / 60);
                    const minutes = duration % 60;
                    const durationText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                    
                    // Find zones for start and current location
                    let startZone = 'Unknown';
                    let currentZone = 'On Route';
                    
                    zones.forEach(zone => {
                        const startDist = calculateDistance(
                            {lat: trip.startLocation[0], lng: trip.startLocation[1]},
                            {lat: zone.lat, lng: zone.lng}
                        );
                        const currentDist = calculateDistance(
                            {lat: trip.currentLocation[0], lng: trip.currentLocation[1]},
                            {lat: zone.lat, lng: zone.lng}
                        );
                        
                        if (startDist * 5280 <= zone.radius) {
                            startZone = zone.name;
                        }
                        if (currentDist * 5280 <= zone.radius) {
                            currentZone = zone.name;
                        }
                    });
                    
                    html += `
                        <div class="card active" style="border-color: var(--success-color); background: rgba(34, 197, 94, 0.05);">
                            <div class="card-header">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div class="user-avatar" style="width: 30px; height: 30px; font-size: 12px;">
                                        ${trip.userName.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div class="card-title">${trip.userName}</div>
                                        <div style="font-size: 11px; color: var(--success-color);">üöó Driving Now</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 18px; font-weight: bold; color: var(--success-color);">
                                        ${trip.distance.toFixed(1)} mi
                                    </div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">${durationText}</div>
                                </div>
                            </div>
                            
                            <div style="margin: 12px 0; padding: 12px; background: var(--bg-primary); border-radius: 6px;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">From</div>
                                        <div style="font-size: 13px; font-weight: 500;">üìç ${startZone}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Currently</div>
                                        <div style="font-size: 13px; font-weight: 500;">üìç ${currentZone}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Current Speed</div>
                                        <div style="font-size: 13px; font-weight: 500;">‚ö° ${trip.waypoints[trip.waypoints.length - 1]?.speed || 0} mph</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Max Speed</div>
                                        <div style="font-size: 13px; font-weight: 500;">üèÅ ${trip.maxSpeed} mph</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Trip Progress</div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="flex: 1; height: 4px; background: var(--bg-tertiary); border-radius: 2px; overflow: hidden;">
                                            <div style="width: ${Math.min(100, (trip.distance / 10) * 100)}%; height: 100%; background: var(--success-color); animation: slideRight 2s ease-in-out infinite;"></div>
                                        </div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">${trip.waypoints.length} points</div>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary btn-block" onclick="selectTrip('${trip.id}')">
                                View Live Route on Map
                            </button>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            // Show recent completed trips
            const recentTrips = trips.slice(-20).reverse();
            
            if (recentTrips.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: 500; margin-bottom: 12px; color: var(--text-primary);">
                            Recent Trips
                        </div>
                `;
                
                // Group trips by date
                const tripsByDate = {};
                recentTrips.forEach(trip => {
                    const dateKey = new Date(trip.startTime).toDateString();
                    if (!tripsByDate[dateKey]) tripsByDate[dateKey] = [];
                    tripsByDate[dateKey].push(trip);
                });
                
                Object.entries(tripsByDate).forEach(([date, dateTrips]) => {
                    const isToday = date === new Date().toDateString();
                    const formattedDate = isToday ? 'Today' : new Date(date).toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    
                    html += `
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid var(--border-color);">
                                üìÖ ${formattedDate}
                            </div>
                    `;
                    
                    dateTrips.forEach(trip => {
                        const duration = trip.duration ? Math.round(trip.duration / 60000) : 0;
                        const hours = Math.floor(duration / 60);
                        const minutes = duration % 60;
                        const durationText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                        
                        // Find zones for start and end
                        let startZone = null;
                        let endZone = null;
                        
                        zones.forEach(zone => {
                            const startDist = calculateDistance(
                                {lat: trip.startLocation[0], lng: trip.startLocation[1]},
                                {lat: zone.lat, lng: zone.lng}
                            );
                            const endDist = calculateDistance(
                                {lat: trip.endLocation[0], lng: trip.endLocation[1]},
                                {lat: zone.lat, lng: zone.lng}
                            );
                            
                            if (startDist * 5280 <= zone.radius) {
                                startZone = zone.name;
                            }
                            if (endDist * 5280 <= zone.radius) {
                                endZone = zone.name;
                            }
                        });
                        
                        html += `
                            <div class="card ${selectedTrip === trip.id ? 'active' : ''}" 
                                 onclick="selectTrip('${trip.id}')" 
                                 style="cursor: pointer; margin-bottom: 8px;">
                                <div class="card-header">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div class="user-avatar" style="width: 24px; height: 24px; font-size: 10px;">
                                            ${trip.userName.charAt(0).toUpperCase()}
                                        </div>
                                        <div>
                                            <div style="font-size: 13px; font-weight: 500;">${trip.userName}</div>
                                            <div style="font-size: 11px; color: var(--text-secondary);">
                                                ${new Date(trip.startTime).toLocaleTimeString('en-US', { 
                                                    hour: 'numeric', 
                                                    minute: '2-digit' 
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 16px; font-weight: bold; color: var(--primary-color);">
                                            ${trip.distance.toFixed(1)} mi
                                        </div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">${durationText}</div>
                                    </div>
                                </div>
                                
                                ${startZone || endZone ? `
                                    <div style="margin: 8px 0; padding: 8px; background: var(--bg-primary); border-radius: 4px; font-size: 12px;">
                                        ${startZone ? `<span style="color: var(--text-secondary);">From:</span> ${startZone}` : ''}
                                        ${startZone && endZone ? ' ‚Üí ' : ''}
                                        ${endZone ? `<span style="color: var(--text-secondary);">To:</span> ${endZone}` : ''}
                                    </div>
                                ` : ''}
                                
                                <div class="card-details">
                                    <div class="card-detail">‚ö° Avg ${trip.averageSpeed?.toFixed(0) || 0} mph</div>
                                    <div class="card-detail">üèÅ Max ${trip.maxSpeed} mph</div>
                                    <div class="card-detail">‚èπÔ∏è ${trip.stops?.length || 0} stops</div>
                                    <div class="card-detail">üìç ${trip.waypoints?.length || 0} points</div>
                                </div>
                                
                                ${selectedTrip === trip.id ? `
                                    <div class="trip-details" style="margin-top: 12px;">
                                        ${trip.aiSummary ? `
                                            <div class="ai-summary">
                                                <div class="ai-summary-header">
                                                    <span>ü§ñ</span>
                                                    <span>AI Summary</span>
                                                </div>
                                                ${trip.aiSummary}
                                            </div>
                                        ` : (config.enableAI && config.geminiKey ? `
                                            <button class="btn btn-secondary btn-block" onclick="event.stopPropagation(); generateAISummaryForTrip('${trip.id}')">
                                                ü§ñ Generate AI Summary
                                            </button>
                                        ` : (!config.geminiKey ? `
                                            <div style="padding: 8px; background: var(--bg-tertiary); border-radius: 4px; font-size: 12px; color: var(--text-secondary); text-align: center;">
                                                Add a Gemini API key in Settings to get AI summaries
                                            </div>
                                        ` : ''))}
                                        
                                        <button class="btn btn-primary btn-block" style="margin-top: 8px;" onclick="event.stopPropagation(); showTripRoute('${trip.id}')">
                                            üó∫Ô∏è View Route on Map
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            }
            
            // Empty state
            if (activeTripsArray.length === 0 && recentTrips.length === 0) {
                html = `
                    <div class="empty-state">
                        <div class="empty-icon">üöó</div>
                        <div class="empty-title">No Driving Activity</div>
                        <div class="empty-description">Trips will appear when family members drive</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function generateAISummaryForTrip(tripId) {
            const trip = trips.find(t => t.id === tripId);
            if (trip) {
                generateAISummary(trip);
                // Refresh the panel after a delay
                setTimeout(() => updateDrivingPanel(), 3000);
            }
        }
        
        function showTripRoute(tripId) {
            const trip = trips.find(t => t.id === tripId);
            if (trip) {
                showTripRoute(trip);
            }
        }
        
        function updateTimelinePanel() {
            const container = document.getElementById('timelineContent');
            let events = [];
            
            // Filter by date range
            let startDate = new Date();
            if (timelineRange === 'today') {
                startDate.setHours(0, 0, 0, 0);
            } else if (timelineRange === 'week') {
                startDate.setDate(startDate.getDate() - 7);
            } else if (timelineRange === 'month') {
                startDate.setDate(startDate.getDate() - 30);
            }
            
            // Combine zone events and trips
            zoneEvents.forEach(event => {
                if (new Date(event.timestamp) >= startDate) {
                    events.push({
                        ...event,
                        type: 'zone',
                        icon: event.type === 'enter' ? 'üì•' : 'üì§',
                        color: event.type === 'enter' ? '#22c55e' : '#f97316',
                        title: `${event.userName} ${event.type === 'enter' ? 'arrived at' : 'left'} ${event.zoneName}`
                    });
                }
            });
            
            trips.forEach(trip => {
                if (new Date(trip.startTime) >= startDate) {
                    events.push({
                        id: trip.id,
                        timestamp: trip.startTime,
                        type: 'trip',
                        icon: 'üöó',
                        color: '#3b82f6',
                        title: `${trip.userName} completed trip`,
                        description: `${trip.distance?.toFixed(1) || 0} miles in ${Math.round((trip.duration || 0) / 60000)} minutes`
                    });
                }
            });
            
            // Sort by time
            events.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (events.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìÖ</div>
                        <div class="empty-title">No Events</div>
                        <div class="empty-description">Activity will appear here</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            events.slice(0, 50).forEach(event => {
                html += `
                    <div class="visit-item">
                        <div class="visit-time">${formatTime(event.timestamp)}</div>
                        <div style="font-size: 13px;">
                            ${event.icon} ${event.title}
                        </div>
                        ${event.description ? `<div class="visit-duration">${event.description}</div>` : ''}
                        ${event.duration ? `<div class="visit-duration">Duration: ${event.duration.toFixed(0)} minutes</div>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function updateNotificationsPanel() {
            const container = document.getElementById('notificationRules');
            
            if (notificationRules.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîî</div>
                        <div class="empty-title">No Rules</div>
                        <div class="empty-description">Add rules to get notifications</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            notificationRules.forEach(rule => {
                html += `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">${rule.name}</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label class="switch">
                                    <input type="checkbox" ${rule.enabled ? 'checked' : ''} 
                                           onchange="toggleRule('${rule.id}')">
                                    <span class="slider"></span>
                                </label>
                                <button class="zone-btn" onclick="deleteRule('${rule.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            When ${rule.userId === 'all' ? 'anyone' : users.find(u => u.id === rule.userId)?.name || rule.userId}
                            ${rule.eventType === 'both' ? 'enters or leaves' : rule.eventType + 's'}
                            ${rule.zoneId === 'all' ? 'any zone' : zones.find(z => z.id === rule.zoneId)?.name || rule.zoneId}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // User Actions
        // ==========================================
        
        function selectUser(userId) {
            selectedUser = selectedUser === userId ? null : userId;
            
            if (selectedUser) {
                const user = users.find(u => u.id === selectedUser);
                if (user) {
                    map.setView([user.lat, user.lng], 16);
                }
            }
            
            updateUsersPanel();
            updateMap();
        }
        
        function selectTrip(tripId) {
            if (selectedTrip === tripId) {
                clearTripRoute();
                selectedTrip = null;
            } else {
                selectedTrip = tripId;
                const trip = [...Object.values(activeTrips), ...trips].find(t => t.id === tripId);
                if (trip) {
                    showTripRoute(trip);
                }
            }
            
            updateDrivingPanel();
        }
        
        function setTimelineRange(range) {
            timelineRange = range;
            
            // Update button states
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(range)) {
                    btn.classList.add('active');
                }
            });
            
            updateTimelinePanel();
        }
        
        function showDatePicker() {
            // Would implement a date range picker here
            alert('Date range picker not implemented in this demo');
        }
        
        // ==========================================
        // Settings Management
        // ==========================================
        
        function saveAllSettings() {
            config.enableTrips = document.getElementById('enableTrips').checked;
            config.enableNotifications = document.getElementById('enableNotifications').checked;
            config.enableAI = document.getElementById('enableAI').checked;
            config.geminiKey = document.getElementById('geminiKey').value;
            config.tripSpeedThreshold = parseInt(document.getElementById('tripSpeed').value);
            config.tripStopDuration = parseInt(document.getElementById('tripStop').value);
            config.refreshInterval = parseInt(document.getElementById('refreshInterval').value);
            
            const configToSave = {
                ...config,
                hassUrl,
                hassToken,
                selectedEntities
            };
            
            localStorage.setItem('familyMapperConfig', JSON.stringify(configToSave));
            
            if (config.enableAI && config.geminiKey) {
                document.getElementById('aiStatus').style.display = 'block';
            } else {
                document.getElementById('aiStatus').style.display = 'none';
            }
            
            // Update notification UI
            updateNotificationUI();
            
            startRefreshTimer();
            alert('Settings saved!');
        }
        
        function toggleAISettings() {
            const enabled = document.getElementById('enableAI').checked;
            document.getElementById('aiSettings').style.display = enabled ? 'block' : 'none';
        }
        
        function toggleRule(ruleId) {
            const rule = notificationRules.find(r => r.id === ruleId);
            if (rule) {
                rule.enabled = !rule.enabled;
                localStorage.setItem('familyMapperNotifications', JSON.stringify(notificationRules));
            }
        }
        
        function deleteRule(ruleId) {
            if (!confirm('Delete this rule?')) return;
            
            notificationRules = notificationRules.filter(r => r.id !== ruleId);
            localStorage.setItem('familyMapperNotifications', JSON.stringify(notificationRules));
            updateNotificationsPanel();
        }
        
        // ==========================================
        // Mock Data
        // ==========================================
        
        function loadMockData() {
            users = [
                { id: 'person_john', name: 'John', lat: 34.0522, lng: -118.2437, battery: 88, speed: 0, state: 'home', lastUpdated: new Date() },
                { id: 'person_jane', name: 'Jane', lat: 34.0622, lng: -118.2537, battery: 65, speed: 32, state: 'away', lastUpdated: new Date() },
                { id: 'person_kid', name: 'Kid', lat: 34.0422, lng: -118.2337, battery: 92, speed: 0, state: 'school', lastUpdated: new Date() }
            ];
            
            // Simulate Jane driving
            activeTrips['person_jane'] = {
                id: 'trip_demo',
                userId: 'person_jane',
                userName: 'Jane',
                startTime: new Date(Date.now() - 600000),
                startLocation: [34.0522, -118.2437],
                currentLocation: [34.0622, -118.2537],
                distance: 3.2,
                maxSpeed: 45,
                waypoints: [
                    {lat: 34.0522, lng: -118.2437, timestamp: new Date(Date.now() - 600000)},
                    {lat: 34.0572, lng: -118.2487, timestamp: new Date(Date.now() - 300000)},
                    {lat: 34.0622, lng: -118.2537, timestamp: new Date()}
                ],
                status: 'active'
            };
            
            updateMap();
            updatePanels();
            
            const mockZones = [
                { id: 'zone_home', name: 'Home', lat: 34.0522, lng: -118.2437, radius: 100, color: '#22c55e' },
                { id: 'zone_work', name: 'Work', lat: 34.0622, lng: -118.2537, radius: 150, color: '#3b82f6' },
                { id: 'zone_school', name: 'School', lat: 34.0422, lng: -118.2337, radius: 200, color: '#f97316' }
            ];
            
            zones = mockZones;
            updateZonesOnMap();
        }
        
        function updateMockData() {
            // Simulate movement
            if (users[1]) {
                users[1].speed = 25 + Math.random() * 20;
                users[1].lat += (Math.random() - 0.5) * 0.001;
                users[1].lng += (Math.random() - 0.5) * 0.001;
                users[1].battery = Math.max(20, users[1].battery - 0.1);
            }
            
            processUserMovements(users);
            updateMap();
            updatePanels();
        }
        
        // ==========================================
        // Helper Functions
        // ==========================================
        
        function formatTime(date) {
            if (!date) return 'Unknown';
            
            const now = new Date();
            const time = new Date(date);
            const diff = now - time;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            
            return time.toLocaleDateString();
        }
        
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
